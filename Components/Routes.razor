@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager Nav

<CascadingAuthenticationState>
    <Router AppAssembly="@typeof(Program).Assembly" NotFoundPage="typeof(Pages.NotFound)">
        <Found Context="routeData">
            @if (routeData.PageType == typeof(Pages.Login) || routeData.PageType == typeof(Pages.CreateAccount))
            {
                <RouteView RouteData="@routeData" DefaultLayout="@typeof(Layout.MainLayout)" />
            }
            else
            {
                <AuthorizeRouteView RouteData="@routeData" DefaultLayout="@typeof(Layout.MainLayout)">
                    <NotAuthorized>
                        <RedirectToLogin />
                    </NotAuthorized>
                </AuthorizeRouteView>
            }

            <FocusOnNavigate RouteData="@routeData" Selector="h1" />
        </Found>
    </Router>
</CascadingAuthenticationState>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private bool _sent;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_sent) return;

        var path = new Uri(Nav.Uri).AbsolutePath.ToLowerInvariant();

        // Allow these pages without login
        if (path == "/login" || path == "/create-account")
        {
            // If they're already logged in, don't let them sit on login screens
            var authStateAllowed = await (AuthenticationStateTask
                ?? Task.FromResult(new AuthenticationState(new ClaimsPrincipal())));

            var authedAllowed = authStateAllowed.User?.Identity?.IsAuthenticated == true;

            if (authedAllowed && path == "/login")
            {
                _sent = true;
                Nav.NavigateTo("/", replace: true);
            }

            return;
        }

        // For all other routes, only redirect if NOT logged in
        var authState = await (AuthenticationStateTask
            ?? Task.FromResult(new AuthenticationState(new ClaimsPrincipal())));

        var authed = authState.User?.Identity?.IsAuthenticated == true;

        if (!authed)
        {
            _sent = true;
            Nav.NavigateTo("/login", replace: true);
        }
    }
}
